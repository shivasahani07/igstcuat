/**
 * Test class for IGSTCSupportCaseController
 */
@IsTest
private class IGSTCSupportCaseControllerTest {

    private static String getFirstPicklistValue(String objName, String fieldName) {
        Schema.SObjectType t = Schema.getGlobalDescribe().get(objName);
        if (t == null) return null;
        Schema.SObjectField f = t.getDescribe().fields.getMap().get(fieldName);
        if (f == null) return null;
        List<Schema.PicklistEntry> ple = f.getDescribe().getPicklistValues();
        return (ple != null && !ple.isEmpty()) ? ple[0].getValue() : null;
    }

    @TestSetup
    static void setupTestData() {
        Campaign camp = new Campaign(Name = 'Test Campaign', EndDate = Date.today().addDays(30));
        insert camp;

        Year__c yearRec = new Year__c(Name = '2025', Is_Active__c = true, Is_Current_Year__c = true);
        insert yearRec;

        String yearVal = getFirstPicklistValue('YealyCall__c', 'Year__c');
        YealyCall__c yearlyCall = new YealyCall__c();
        if (String.isNotBlank(yearVal)) {
            yearlyCall.Year__c = yearVal;
        } else {
            yearlyCall.put('Year__c', yearRec.Id);
        }
        insert yearlyCall;

        Application_Proposal__c proposal = new Application_Proposal__c(
            Campaign__c = camp.Id,
            Proposal_Stages__c = 'Draft',
            yearly_Call__c = yearlyCall.Id,
            Title_Of__c = 'Test Proposal'
        );
        insert proposal;
    }

    @IsTest
    static void testCreateCase_Success_WithoutProposalId() {
        Test.startTest();
        String result = IGSTCSupportCaseController.createCase(
            'Test User',
            'testuser@example.com',
            'Test comment for support',
            null
        );
        Test.stopTest();

        System.assertEquals('SUCCESS', result, 'Should return SUCCESS when all required fields are provided');
        List<Case> cases = [SELECT Id, SuppliedName, SuppliedEmail, Subject, Origin, Comments__c, Application__c
                            FROM Case WHERE SuppliedEmail = 'testuser@example.com'];
        System.assertEquals(1, cases.size(), 'One Case should be created');
        System.assertEquals('Test User', cases[0].SuppliedName);
        System.assertEquals('testuser@example.com', cases[0].SuppliedEmail);
        System.assertEquals('IGSTC Support Request', cases[0].Subject);
        System.assertEquals('Web', cases[0].Origin);
        System.assertEquals('Test comment for support', cases[0].Comments__c);
        System.assertEquals(null, cases[0].Application__c, 'Application__c should be null when proposalId is null');
    }

    @IsTest
    static void testCreateCase_Success_WithProposalId() {
        Application_Proposal__c proposal = [SELECT Id FROM Application_Proposal__c LIMIT 1];

        Test.startTest();
        String result = IGSTCSupportCaseController.createCase(
            'Support User',
            'support@example.com',
            'Need help with my application',
            proposal.Id
        );
        Test.stopTest();

        System.assertEquals('SUCCESS', result, 'Should return SUCCESS when proposalId is provided');
        List<Case> cases = [SELECT Id, Application__c FROM Case WHERE SuppliedEmail = 'support@example.com'];
        System.assertEquals(1, cases.size());
        System.assertEquals(proposal.Id, cases[0].Application__c, 'Application__c should be set when proposalId is provided');
    }

    @IsTest
    static void testCreateCase_Success_WithEmptyProposalId() {
        Test.startTest();
        String result = IGSTCSupportCaseController.createCase(
            'Another User',
            'another@example.com',
            'Comment with empty proposal id',
            ''
        );
        Test.stopTest();

        System.assertEquals('SUCCESS', result);
        List<Case> cases = [SELECT Id, Application__c FROM Case WHERE SuppliedEmail = 'another@example.com'];
        System.assertEquals(1, cases.size());
        System.assertEquals(null, cases[0].Application__c);
    }

    @IsTest
    static void testCreateCase_Validation_BlankName() {
        Test.startTest();
        String result = IGSTCSupportCaseController.createCase(
            '',
            'blankname@example.com',
            'Valid comment',
            null
        );
        Test.stopTest();

        System.assertEquals('ERROR: Please fill all mandatory fields.', result);
        List<Case> cases = [SELECT Id FROM Case WHERE SuppliedEmail = 'blankname@example.com'];
        System.assertEquals(0, cases.size(), 'No Case should be created when name is blank');
    }

    @IsTest
    static void testCreateCase_Validation_BlankEmail() {
        Test.startTest();
        String result = IGSTCSupportCaseController.createCase(
            'Valid Name',
            '',
            'Valid comment',
            null
        );
        Test.stopTest();

        System.assertEquals('ERROR: Please fill all mandatory fields.', result);
        List<Case> cases = [SELECT Id FROM Case WHERE SuppliedName = 'Valid Name'];
        System.assertEquals(0, cases.size(), 'No Case should be created when email is blank');
    }

    @IsTest
    static void testCreateCase_Validation_BlankComment() {
        Test.startTest();
        String result = IGSTCSupportCaseController.createCase(
            'Valid Name',
            'valid@example.com',
            '',
            null
        );
        Test.stopTest();

        System.assertEquals('ERROR: Please fill all mandatory fields.', result);
        List<Case> cases = [SELECT Id FROM Case WHERE SuppliedEmail = 'valid@example.com'];
        System.assertEquals(0, cases.size(), 'No Case should be created when comment is blank');
    }

    @IsTest
    static void testCreateCase_Validation_AllBlank() {
        Test.startTest();
        String result = IGSTCSupportCaseController.createCase(
            '',
            '',
            '',
            null
        );
        Test.stopTest();

        System.assertEquals('ERROR: Please fill all mandatory fields.', result);
    }
}